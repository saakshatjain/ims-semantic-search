name: Notices Pipeline

on:
  schedule:
    # Runs Every hour from 09:00 to 17:00 IST 
    - cron: "30 3-11 * * *"
  workflow_dispatch:        # manual trigger

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install PDF and document dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            poppler-utils \
            ghostscript \
            build-essential \
            python3-dev \
            libxml2-dev \
            libxslt1-dev \
            antiword \
            unrtf

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install supabase-py sentence-transformers numpy textract pillow pdfplumber camelot-py[cv]
          fi

      - name: Run scraper (adds new notices)
        run: |
          python -u scraper.py

      - name: Run worker to process new notices
        run: |
          python -u worker/worker.py