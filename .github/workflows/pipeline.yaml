name: Notices Pipeline

on:
  schedule:
    # Runs Every hour from 09:00 to 17:00 IST 
    - cron: "30 3-11 * * *"
  workflow_dispatch:        # manual trigger

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      TESSDATA_PREFIX: /usr/share/tesseract-ocr/4.00/tessdata

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install apt packages (Tesseract + PDF deps)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            tesseract-ocr \
            tesseract-ocr-eng \
            libtesseract-dev \
            poppler-utils \
            ghostscript \
            build-essential
          
          # Create tessdata directory if it doesn't exist
          sudo mkdir -p /usr/share/tesseract-ocr/4.00/tessdata
          
          # Copy language data to correct location
          sudo cp /usr/share/tesseract-ocr/tessdata/eng.traineddata /usr/share/tesseract-ocr/4.00/tessdata/
          
          # Verify setup
          echo "Verifying tesseract installation..."
          tesseract --version
          which tesseract
          ls -la /usr/share/tesseract-ocr/4.00/tessdata/
          echo "TESSDATA_PREFIX=$TESSDATA_PREFIX"
          
          # Test tesseract
          echo "Testing tesseract..."
          echo "Hello World" > test.txt
          tesseract test.txt stdout

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install supabase-py sentence-transformers numpy pytesseract pillow pdfplumber camelot-py[cv]
          fi

      - name: Run scraper (adds new notices)
        run: |
          python -u scraper.py

      - name: Run worker to process new notices
        env:
          TESSDATA_PREFIX: /usr/share/tesseract-ocr/4.00/tessdata
        run: |
          python -u worker/worker.py